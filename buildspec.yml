version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: us-east-1
    BUILD_DIR: target

phases:
  install:
    runtime-versions:
      java: corretto17
      nodejs: 22
    commands:
      - echo "Installing system and build dependencies..."
      - apt-get update -y
      - apt-get install -y git curl
      - curl -O https://download.clojure.org/install/linux-install-1.11.1.1182.sh
      - chmod +x linux-install-1.11.1.1182.sh
      - ./linux-install-1.11.1.1182.sh
      - npm install -g yarn
      - echo "Environment setup complete."

  pre_build:
    commands:
      - echo "Installing frontend dependencies..."
      - yarn install
      - echo "Frontend dependencies installed."

  build:
    commands:
      - echo "Building frontend for production..."
      - yarn build
      - echo "Frontend build complete."
      - echo "Building Metabase drivers..."
      - ./bin/build-drivers.sh
      - echo "Starting Metabase backend build (JAR)..."
      - lein uberjar
      - echo "Verifying build output..."
      - ls -lh target

  post_build:
    commands:
      - echo "Metabase build completed successfully."
      - echo "Artifact path: target/metabase.jar"

artifacts:
  files:
    - target/metabase.jar
  discard-paths: yes
