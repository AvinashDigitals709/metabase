version: 0.2

env:
  variables:
    MB_SKIP_INTERACTIVE: "true"   # Skip interactive build prompts
    MB_EDITION: "oss"
    OUTPUT_DIR: "target/uberjar"

phases:
  install:
    runtime-versions:
      java: corretto21
      nodejs: 18
    commands:
      - echo "ğŸ”§ Installing dependencies..."
      - apt-get update -y
      - apt-get install -y curl wget git unzip bash
      - echo "âš™ï¸ Installing Clojure..."
      - curl -O https://download.clojure.org/install/linux-install-1.11.1.1413.sh
      - chmod +x linux-install-1.11.1.1413.sh
      - ./linux-install-1.11.1.1413.sh
      - echo "ğŸ“¦ Installing Yarn..."
      - npm install --global yarn
      - echo "âœ… Environment setup complete."

  pre_build:
    commands:
      - echo "ğŸš€ Starting pre-build phase..."
      - cd $CODEBUILD_SRC_DIR
      - echo "ğŸ“ Installing frontend dependencies..."
      - yarn install --frozen-lockfile || yarn install
      - echo "ğŸ“¦ Adding missing dependency react-beautiful-dnd..."
      - yarn add react-beautiful-dnd
      - echo "âœ… Frontend dependencies ready."

  build:
    commands:
      - echo "ğŸ—ï¸ Building Metabase application..."
      - chmod +x ./bin/build.sh
      - MB_EDITION=$MB_EDITION MB_SKIP_INTERACTIVE=$MB_SKIP_INTERACTIVE ./bin/build.sh
      - echo "âœ… Build completed. JAR should be in $OUTPUT_DIR"
      - ls -lh $OUTPUT_DIR

  post_build:
    commands:
      - echo "ğŸ“¦ Preparing artifacts for deployment..."
      - mkdir -p artifacts/scripts
      - cp $OUTPUT_DIR/metabase.jar artifacts/
      - cp appspec.yml artifacts/
      - cp -r scripts/* artifacts/scripts/
      - echo "âœ… All artifacts prepared for deployment."

artifacts:
  files:
    - artifacts/**/*
  discard-paths: no
