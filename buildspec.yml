version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17
    commands:
      - echo "ğŸ”§ Updating system packages..."
      - apt-get update -y

      # â¡ï¸ FIX: Aggressively remove pre-existing Node/npm and binaries that might conflict
      - echo "ğŸ§¹ Removing conflicting Node.js versions and binaries..."
      - apt-get remove -y nodejs npm || true
      - rm -f /usr/local/bin/node /usr/local/bin/npm /usr/local/bin/npx || true 

      - echo "ğŸ“¦ Installing Node.js 22..."
      - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      - apt-get install -y nodejs

      - echo "ğŸ”„ Ensuring correct PATH and refreshing shell lookup..."
      # âš ï¸ CRITICAL CHANGE: Removed 'export PATH=/usr/local/bin:$PATH' 
      # The system PATH should now correctly find the newly installed Node 22 in /usr/bin
      - hash -r

      - echo "ğŸ§¾ Verifying Node.js and npm versions..."
      - which node
      - node -v  # This should now output v22.x.x
      - which npm
      - npm -v

      - echo "âš™ï¸ Installing Clojure..."
      - curl -O https://download.clojure.org/install/linux-install-1.11.1.1413.sh
      - chmod +x linux-install-1.11.1.1413.sh
      - ./linux-install-1.11.1.1413.sh
      - clj -h || true

      - echo "ğŸ“¦ Installing Yarn..."
      - npm install --global yarn
      - yarn -v

      - echo "âœ… Environment setup complete."

  pre_build:
    commands:
      - echo "ğŸš€ Starting pre-build phase..."
      - export PATH=/usr/local/bin:$PATH # Re-exporting PATH here is okay, but less critical now that /usr/local/bin/node is deleted
      - node -v  # Should still show v22.x.x
      - cd $CODEBUILD_SRC_DIR
      - echo "ğŸ“ Installing frontend dependencies..."
      - yarn install --frozen-lockfile || yarn install # This should now SUCCEED

  build:
    commands:
      - echo "ğŸ—ï¸ Building Metabase JAR..."
      - ./bin/build

  post_build:
    commands:
      - echo "ğŸ“¦ Moving build artifacts..."
      - mkdir -p artifacts
      - cp target/uberjar/metabase.jar artifacts/
      - echo "âœ… Build complete."

artifacts:
  files:
    - artifacts/metabase.jar
    - appspec.yml
    - scripts/**/*
